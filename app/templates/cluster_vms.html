{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" style="font-weight: 600;">
            <i class="bi bi-diagram-3 me-2" style="opacity: 0.7;"></i>Cluster Virtual Machines
        </h2>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary active" id="cardView">
                <i class="bi bi-grid-3x3-gap me-1"></i>Cards
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="tableView">
                <i class="bi bi-table me-1"></i>Table
            </button>
        </div>
    </div>

    {% if vms %}
    <div id="cardLayout" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for vm in vms %}
        <div class="col">
            <div class="card h-100 border" style="border-radius: 12px; overflow: hidden;">
                <div class="card-header border-bottom" style="padding: 1.25rem 1.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%); border-bottom: 1px solid rgba(59, 130, 246, 0.15);">
                    <h5 class="card-title mb-0" style="font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="bi bi-pc" style="font-size: 1.2rem; color: #3b82f6;"></i>{{ vm.name }}
                    </h5>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <div class="row g-3 mb-3" style="margin-bottom: 1.5rem !important;">
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-cpu me-2" style="font-size: 1.1rem; color: #3b82f6; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">CPU</div>
                                        <div style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 1rem; font-weight: 600;">{{ vm.cpu_cores }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(139, 92, 246, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-memory me-2" style="font-size: 1.1rem; color: #8b5cf6; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">Memory</div>
                                        <div style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 1rem; font-weight: 600;">{{ vm.memory }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-hdd me-2" style="font-size: 1.1rem; color: #10b981; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">Node</div>
                                        <div style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 1rem; font-weight: 600;">{{ vm.vmi.node if vm.vmi else 'N/A' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(234, 88, 12, 0.05) 0%, rgba(234, 88, 12, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(234, 88, 12, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-activity me-2" style="font-size: 1.1rem; color: #ea580c; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">Status</div>
                                        <div>
                                            {% if vm.running %}
                                                <span class="vm-status" data-vm-name="{{ vm.name }}" style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.375rem 0.625rem; background: rgba(34, 197, 94, 0.15); color: rgb(21, 128, 61); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; display: inline-flex; align-items: center; gap: 0.375rem; font-weight: 600;"><span class="vm-status-dot" style="font-size: 0.5rem;">●</span><span class="vm-status-text">running</span></span>
                                                {% else %}
                                                <span class="vm-status" data-vm-name="{{ vm.name }}" style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.375rem 0.625rem; background: rgba(31, 41, 55, 0.08); color: rgb(55, 65, 81); border: 1px solid rgba(31, 41, 55, 0.25); border-radius: 6px; display: inline-flex; align-items: center; gap: 0.375rem; font-weight: 600;"><span class="vm-status-dot" style="font-size: 0.5rem;">○</span><span class="vm-status-text">stopped</span></span>
                                                {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid rgba(59, 130, 246, 0.1); margin: 0 -1.5rem; padding: 1.25rem 1.5rem 0; background: linear-gradient(180deg, rgba(59, 130, 246, 0.02) 0%, transparent 100%);">
                        <div style="font-size: 0.8125rem;">
                            <div class="mb-3">
                                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0.625rem; font-weight: 600;">
                                    <i class="bi bi-diagram-2 me-1" style="color: #3b82f6;"></i>Pod IPs
                                </div>
                                {% if vm.vmi and vm.vmi.ip_addresses %}
                                <div class="d-flex flex-wrap gap-1">
                                {% for ip in vm.vmi.ip_addresses %}
                                <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ ip }}</code>
                                {% endfor %}
                                </div>
                                {% else %}
                                <span style="opacity: 0.5; font-style: italic;">N/A</span>
                                {% endif %}
                            </div>
                            {% if vm.service %}
                            <div class="mb-3">
                                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0.625rem; font-weight: 600;">
                                    <i class="bi bi-hdd-network me-1" style="color: #8b5cf6;"></i>Service
                                </div>
                                <div style="padding-left: 0.5rem; border-left: 2px solid var(--border-color, #e5e7eb);">
                                    <div class="mb-2"><span style="opacity: 0.6; font-size: 0.75rem;">Type:</span> <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.type }}</code></div>
                                    {% if vm.service.annotations and (vm.service.annotations.get('external-dns.alpha.kubernetes.io/hostname') or vm.service.annotations.get('metallb.io/ip-allocated-from-pool')) %}
                                    <div>
                                        {% if vm.service.annotations.get('external-dns.alpha.kubernetes.io/hostname') %}
                                        <div class="mb-2">
                                            <span style="opacity: 0.6; font-size: 0.75rem;">FQDN:</span>
                                            <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.annotations['external-dns.alpha.kubernetes.io/hostname'] }}</code>
                                        </div>
                                        {% endif %}
                                        {% if vm.service.annotations.get('metallb.io/ip-allocated-from-pool') %}
                                        <div class="mb-2">
                                            <span style="opacity: 0.6; font-size: 0.75rem;">Pool:</span>
                                            <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.annotations['metallb.io/ip-allocated-from-pool'] }}</code>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% if vm.service.external_ips %}
                                    <div class="mb-2"><span style="opacity: 0.6; font-size: 0.75rem;">External IPs:</span>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                        {% for ip in vm.service.external_ips %}
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ ip }}</code>
                                        {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="mb-2"><span style="opacity: 0.6; font-size: 0.75rem;">Cluster IP:</span> <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.cluster_ip }}</code></div>
                                    <div><span style="opacity: 0.6; font-size: 0.75rem;">Ports:</span>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                        {% for port in vm.service.ports %}
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit; white-space: nowrap;">
                                            {{ port.name }}: {{ port.port }}:{{ port.target_port }}/{{ port.protocol }}
                                        </code>
                                        {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if vm.labels %}
                            <div>
                                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0.625rem; font-weight: 600;">
                                    <i class="bi bi-tags me-1" style="color: #10b981;"></i>Labels
                                </div>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for key, value in vm.labels.items() %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ key }}={{ value }}</code>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-footer border-top" style="padding: 1rem 1.5rem; background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.02) 100%); border-top: 1px solid rgba(59, 130, 246, 0.15);">
                    {% set has_ssh = vm.service and vm.service.type == 'LoadBalancer' and vm.service.ports %}
                    {% if has_ssh %}
                        {% set ns = namespace(found=false) %}
                        {% for port in vm.service.ports %}
                            {% if port.port == 22 %}
                                {% set ns.found = true %}
                            {% endif %}
                        {% endfor %}
                        {% set has_ssh = ns.found %}
                    {% else %}
                        {% set has_ssh = false %}
                    {% endif %}
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <!-- Row 1: Power + VNC (left), SSH (right) -->
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 0 0 auto;">
                                {% if vm.running %}
                                <button type="button" class="btn btn-sm btn-danger power-action" data-vm-name="{{ vm.name }}" data-action="stop" style="white-space: nowrap;">
                                    <i class="bi bi-power me-1"></i>Stop
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-sm btn-success power-action" data-vm-name="{{ vm.name }}" data-action="start" style="white-space: nowrap;">
                                    <i class="bi bi-power me-1"></i>Start
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-secondary vnc-button" 
                                        data-url="{{ url_for('main.vnc', vm_name=vm.name, namespace=vm.namespace) }}" 
                                        data-vm-name="{{ vm.name }}" style="white-space: nowrap;">
                                    <i class="bi bi-display me-1"></i>VNC
                                </button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 0 0 auto;">
                                {% if has_ssh %}
                                <button type="button" class="btn btn-sm btn-outline-secondary ssh-button" 
                                        data-url="{{ url_for('main.terminal', vm_name=vm.name, host=vm.service.external_ips[0] if vm.service.external_ips else vm.service.cluster_ip) }}"
                                        data-vm-name="{{ vm.name }}" style="white-space: nowrap;">
                                    <i class="bi bi-terminal me-1"></i>SSH
                                </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Row 2: YAML buttons -->
                        <div style="display: flex; justify-content: flex-start; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <button type="button" class="btn btn-sm btn-outline-secondary view-yaml" data-vm-name="{{ vm.name }}" style="white-space: nowrap;">
                                <i class="bi bi-code-square me-1"></i>VM
                            </button>
                            {% if vm.service %}
                            <button type="button" class="btn btn-sm btn-outline-secondary view-service-yaml" data-service-name="{{ vm.name }}" style="white-space: nowrap;">
                                <i class="bi bi-code-square me-1"></i>Service
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="tableLayout" class="d-none">
        <div class="card border">
            <div class="card-body p-0">
                <table class="table table-hover mb-0" style="font-size: 0.875rem; width: 100%; table-layout: auto;">
                        <thead style="background-color: var(--surface-bg, #f9fafb); border-bottom: 1px solid var(--border-color, #e5e7eb);">
                            <tr>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Name</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Namespace</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Status</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">CPU</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Memory</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Node</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">IP Addresses</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Labels</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vm in vms %}
                            <tr style="border-bottom: 1px solid var(--border-color, #e5e7eb);">
                                <td style="padding: 0.875rem 1rem;">
                                    <i class="bi bi-pc me-2" style="opacity: 0.6;"></i>
                                    <span style="font-weight: 500;">{{ vm.name }}</span>
                                </td>
                                <td style="padding: 0.875rem 1rem;">{{ vm.namespace }}</td>
                                <td style="padding: 0.875rem 1rem;">
                                    <div style="display: flex; align-items: center;">
                                        {% if vm.running %}
                                        <span class="vm-status" data-vm-name="{{ vm.name }}" style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(34, 197, 94, 0.1); color: rgb(21, 128, 61); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 0.25rem; line-height: 1; display: flex; align-items: center; gap: 0.25rem;"><span class="vm-status-dot">●</span><span class="vm-status-text">running</span></span>
                                        {% else %}
                                        <span class="vm-status" data-vm-name="{{ vm.name }}" style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(31, 41, 55, 0.08); color: rgb(55, 65, 81); border: 1px solid rgba(31, 41, 55, 0.25); border-radius: 0.25rem; line-height: 1; display: flex; align-items: center; gap: 0.25rem;"><span class="vm-status-dot">○</span><span class="vm-status-text">stopped</span></span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td style="padding: 0.875rem 1rem;">
                                    <div style="display: flex; align-items: center;">
                                        <i class="bi bi-cpu" style="opacity: 0.5; margin-right: 0.5rem;"></i>
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; background: transparent; color: inherit;">{{ vm.cpu_cores }}</code>
                                    </div>
                                </td>
                                <td style="padding: 0.875rem 1rem;">
                                    <div style="display: flex; align-items: center;">
                                        <i class="bi bi-memory" style="opacity: 0.5; margin-right: 0.5rem;"></i>
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; background: transparent; color: inherit;">{{ vm.memory }}</code>
                                    </div>
                                </td>
                                <td style="padding: 0.875rem 1rem;">
                                    {% if vm.vmi %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.vmi.node }}</code>
                                    {% else %}
                                    <span style="opacity: 0.5; font-style: italic;">N/A</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.875rem 1rem; max-width: 250px;">
                                    {% if vm.vmi and vm.vmi.ip_addresses %}
                                    {% for ip in vm.vmi.ip_addresses %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit; display: inline-block; margin: 0.125rem; word-break: break-all;">{{ ip }}</code>
                                    {% endfor %}
                                    {% else %}
                                    <span style="opacity: 0.5; font-style: italic;">N/A</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.875rem 1rem; max-width: 300px;">
                                    {% for key, value in vm.labels.items() %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit; display: inline-block; margin: 0.125rem; word-break: break-word;">{{ key }}={{ value }}</code>
                                    {% endfor %}
                                </td>
                                <td style="padding: 0.875rem 1rem;">{{ vm.created }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card border">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox mb-3" style="font-size: 4rem; opacity: 0.3; display: block;"></i>
            <h3 style="font-weight: 600; opacity: 0.7; margin-bottom: 0.5rem;">No VMs Found in Cluster</h3>
            <p style="opacity: 0.6; margin-bottom: 0;">No virtual machines were found running in the Kubernetes cluster</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- YAML Modal -->
<div class="modal" id="yamlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">VM YAML Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <pre style="margin: 0; border-radius: 0;"><code id="yamlContent" class="language-yaml" style="display: block; padding: 1.5rem; overflow-x: auto;"></code></pre>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const cardView = document.getElementById('cardView');
    const tableView = document.getElementById('tableView');
    const cardLayout = document.getElementById('cardLayout');
    const tableLayout = document.getElementById('tableLayout');

    // Load saved preference
    const viewPreference = localStorage.getItem('clusterVmViewPreference') || 'card';
    if (viewPreference === 'table') {
        showTableView();
    }

    cardView.addEventListener('click', function() {
        showCardView();
        localStorage.setItem('clusterVmViewPreference', 'card');
    });

    tableView.addEventListener('click', function() {
        showTableView();
        localStorage.setItem('clusterVmViewPreference', 'table');
    });

    function showCardView() {
        cardLayout.classList.remove('d-none');
        tableLayout.classList.add('d-none');
        cardView.classList.add('active');
        tableView.classList.remove('active');
    }

    function showTableView() {
        cardLayout.classList.add('d-none');
        tableLayout.classList.remove('d-none');
        cardView.classList.remove('active');
        tableView.classList.add('active');
    }

    // Load Highlight.js
    const hljs = window.hljs;

    // YAML Modal handling
    const yamlModal = new bootstrap.Modal(document.getElementById('yamlModal'));
    const yamlContent = document.getElementById('yamlContent');

    document.querySelectorAll('.view-yaml').forEach(button => {
        button.addEventListener('click', async function() {
            const vmName = this.dataset.vmName;
            try {
                const response = await fetch(`/api/vm/${vmName}/yaml`);
                const yaml = await response.text();
                yamlContent.textContent = yaml;
                if (hljs) {
                    delete yamlContent.dataset.highlighted;
                    hljs.highlightElement(yamlContent);
                }
                yamlModal.show();
            } catch (error) {
                console.error('Error fetching YAML:', error);
            }
        });
    });

    document.querySelectorAll('.view-service-yaml').forEach(button => {
        button.addEventListener('click', async function() {
            const serviceName = this.dataset.serviceName;
            try {
                const response = await fetch(`/api/service/${serviceName}/yaml`);
                const yaml = await response.text();
                yamlContent.textContent = yaml;
                if (hljs) {
                    delete yamlContent.dataset.highlighted;
                    hljs.highlightElement(yamlContent);
                }
                yamlModal.show();
            } catch (error) {
                console.error('Error fetching Service YAML:', error);
            }
        });
    });

    // Power control (start/stop)
    document.querySelectorAll('.power-action').forEach(button => {
        button.addEventListener('click', async function() {
            const vmName = this.dataset.vmName;
            const action = this.dataset.action; // 'start' or 'stop'
            // Optimistic UI: disable button to prevent double clicks
            this.disabled = true;
            // Update button and status inline
            const originalLabel = this.innerHTML;
            const statusEl = document.querySelector(`.vm-status[data-vm-name="${vmName}"]`);
            const statusTextEl = statusEl ? statusEl.querySelector('.vm-status-text') : null;
            const statusDotEl = statusEl ? statusEl.querySelector('.vm-status-dot') : null;
            const isStart = action === 'start';
            this.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>${isStart ? 'Starting…' : 'Stopping…'}`;
            if (statusEl && statusTextEl && statusDotEl) {
                statusTextEl.textContent = isStart ? 'starting…' : 'shutting down…';
                statusEl.style.background = 'rgba(234, 179, 8, 0.15)'; // amber
                statusEl.style.color = 'rgb(161, 98, 7)';
                statusEl.style.border = '1px solid rgba(234, 179, 8, 0.3)';
                statusDotEl.textContent = '●';
            }
            try {
                const resp = await fetch(`/api/vm/${vmName}/power/${action}`, {
                    method: 'POST'
                });
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(text || `Power action failed (${resp.status})`);
                }
                // Poll VM/VMI state until it reaches desired state or timeout
                const desiredRunning = isStart;
                const deadline = Date.now() + 45000; // 45s timeout
                const delay = (ms) => new Promise(r => setTimeout(r, ms));
                let reached = false;
                while (Date.now() < deadline) {
                    try {
                        const sj = await fetch(`/api/vmi/${vmName}/status`);
                        if (sj.ok) {
                            const s = await sj.json();
                            // Update interim status messages based on VMI phase
                            if (statusEl && statusTextEl) {
                                const phase = s.vmi_phase;
                                if (phase === 'Scheduling' || phase === 'Pending') {
                                    statusTextEl.textContent = 'scheduling…';
                                } else if (phase === 'Running') {
                                    statusTextEl.textContent = desiredRunning ? 'starting…' : 'shutting down…';
                                } else if (phase === 'Succeeded') {
                                    statusTextEl.textContent = 'stopped';
                                } else if (phase === 'Failed') {
                                    statusTextEl.textContent = 'error';
                                    statusEl.style.background = 'rgba(239, 68, 68, 0.15)';
                                    statusEl.style.color = 'rgb(185, 28, 28)';
                                    statusEl.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                                }
                            }
                            if (typeof s.spec_running === 'boolean') {
                                if (s.spec_running === desiredRunning) { reached = true; break; }
                            }
                        }
                    } catch {}
                    await delay(1500);
                }
                if (reached) {
                    // Update status pill to final state and swap button
                    if (statusEl && statusTextEl && statusDotEl) {
                        if (desiredRunning) {
                            statusTextEl.textContent = 'running';
                            statusEl.style.background = 'rgba(34, 197, 94, 0.15)';
                            statusEl.style.color = 'rgb(21, 128, 61)';
                            statusEl.style.border = '1px solid rgba(34, 197, 94, 0.3)';
                            statusDotEl.textContent = '●';
                        } else {
                            statusTextEl.textContent = 'stopped';
                            statusEl.style.background = 'rgba(31, 41, 55, 0.08)';
                            statusEl.style.color = 'rgb(55, 65, 81)';
                            statusEl.style.border = '1px solid rgba(31, 41, 55, 0.25)';
                            statusDotEl.textContent = '○';
                        }
                    }
                    // Swap power button to opposite action
                    this.classList.toggle('btn-danger', desiredRunning === false);
                    this.classList.toggle('btn-success', desiredRunning === true);
                    this.dataset.action = desiredRunning ? 'stop' : 'start';
                    this.innerHTML = desiredRunning ? '<i class="bi bi-power me-1"></i>Stop' : '<i class="bi bi-power me-1"></i>Start';
                } else {
                    // Fallback: reload to reflect server state
                    window.location.reload();
                }
            } catch (err) {
                console.error('Power action error:', err);
                this.disabled = false;
                this.innerHTML = originalLabel;
                if (statusEl && statusTextEl && statusDotEl) {
                    // revert to unknown/neutral state
                    statusTextEl.textContent = 'unknown';
                    statusEl.style.background = 'rgba(31, 41, 55, 0.08)';
                    statusEl.style.color = 'rgb(55, 65, 81)';
                    statusEl.style.border = '1px solid rgba(31, 41, 55, 0.25)';
                    statusDotEl.textContent = '○';
                }
                alert(`Failed to ${action} VM ${vmName}: ${err.message}`);
            }
        });
    });

    // Real-time status polling for all VMs (card and table views)
    const statusEls = Array.from(document.querySelectorAll('.vm-status'));
    const vmNames = [...new Set(statusEls.map(el => el.dataset.vmName))];
    function applyStatus(el, data) {
        const textEl = el.querySelector('.vm-status-text');
        const dotEl = el.querySelector('.vm-status-dot');
        if (!textEl || !dotEl) return;
        const phase = (data.vmi_phase || '').toLowerCase();
        const running = data.spec_running === true;
        const ready = data.ready === true;
        // Decide display text
        let displayText = 'unknown';
        if (phase) {
            if (phase.includes('schedule') || phase === 'pending') {
                displayText = 'scheduling…';
            } else if (phase === 'running') {
                displayText = ready ? 'running' : 'starting…';
            } else if (phase === 'succeeded') {
                displayText = 'stopped';
            } else if (phase === 'failed') {
                displayText = 'error';
            } else {
                displayText = phase;
            }
        } else {
            displayText = running ? 'running' : 'stopped';
        }
        textEl.textContent = displayText;
        // Style
        if (displayText === 'running') {
            el.style.background = 'rgba(34, 197, 94, 0.15)';
            el.style.color = 'rgb(21, 128, 61)';
            el.style.border = '1px solid rgba(34, 197, 94, 0.3)';
            dotEl.textContent = '●';
        } else if (displayText === 'stopped') {
            el.style.background = 'rgba(0, 0, 0, 0.06)';
            el.style.color = 'rgba(0, 0, 0, 0.6)';
            el.style.border = '1px solid rgba(0, 0, 0, 0.15)';
            dotEl.textContent = '○';
        } else if (displayText === 'error') {
            el.style.background = 'rgba(239, 68, 68, 0.15)';
            el.style.color = 'rgb(185, 28, 28)';
            el.style.border = '1px solid rgba(239, 68, 68, 0.3)';
            dotEl.textContent = '●';
        } else {
            // transitional (scheduling/starting…)
            el.style.background = 'rgba(234, 179, 8, 0.15)';
            el.style.color = 'rgb(161, 98, 7)';
            el.style.border = '1px solid rgba(234, 179, 8, 0.3)';
            dotEl.textContent = '●';
        }
        // Optional: show primary IP or node tooltip
        if (data.primary_ip || data.node) {
            el.title = [data.primary_ip, data.node].filter(Boolean).join(' • ');
        }
    }
    async function pollStatuses() {
        for (const name of vmNames) {
            try {
                const r = await fetch(`/api/vmi/${name}/status`);
                if (!r.ok) continue;
                const data = await r.json();
                statusEls.filter(el => el.dataset.vmName === name).forEach(el => applyStatus(el, data));
            } catch {}
        }
    }
    // Initial poll and interval
    if (vmNames.length > 0) {
        pollStatuses();
        setInterval(pollStatuses, 5000);
    }

    // SSH popup handling (normal browser popup, not a modal)
    document.querySelectorAll('.ssh-button').forEach(button => {
        button.addEventListener('click', function() {
            const openUrl = this.dataset.url + '&embedded=1';
            const features = [
              'popup=yes', 'toolbar=no', 'location=no', 'menubar=no', 'status=no',
              'scrollbars=yes', 'resizable=yes',
              `width=${Math.min(screen.availWidth, 1200)}`,
              `height=${Math.min(screen.availHeight, 800)}`
            ].join(',');
            const win = window.open(openUrl, 'kubevirt-ssh', features);
            if (win) { try { win.focus(); } catch(e){} }
        });
    });

    // VNC popup handling (normal browser popup, not a modal)
    document.querySelectorAll('.vnc-button').forEach(button => {
        button.addEventListener('click', function() {
            const openUrl = this.dataset.url + '&embedded=1';
            const features = [
              'popup=yes', 'toolbar=no', 'location=no', 'menubar=no', 'status=no',
              'scrollbars=yes', 'resizable=yes',
              `width=${Math.min(screen.availWidth, 1280)}`,
              `height=${Math.min(screen.availHeight, 800)}`
            ].join(',');
            const win = window.open(openUrl, 'kubevirt-vnc', features);
            if (win) { try { win.focus(); } catch(e){} }
        });
    });
});
</script>
{% endblock %}
