{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" style="font-weight: 600;">
            <i class="bi bi-diagram-3 me-2" style="opacity: 0.7;"></i>Cluster Virtual Machines
        </h2>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary active" id="cardView">
                <i class="bi bi-grid-3x3-gap me-1"></i>Cards
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="tableView">
                <i class="bi bi-table me-1"></i>Table
            </button>
        </div>
    </div>

    {% if vms %}
    <div id="cardLayout" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for vm in vms %}
        <div class="col">
            <div class="card h-100 border" style="border-radius: 12px; overflow: hidden;">
                <div class="card-header border-bottom" style="padding: 1.25rem 1.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%); border-bottom: 1px solid rgba(59, 130, 246, 0.15);">
                    <h5 class="card-title mb-0" style="font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="bi bi-pc" style="font-size: 1.2rem; color: #3b82f6;"></i>{{ vm.name }}
                    </h5>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <div class="row g-3 mb-3" style="margin-bottom: 1.5rem !important;">
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-cpu me-2" style="font-size: 1.1rem; color: #3b82f6; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">CPU</div>
                                        <div style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 1rem; font-weight: 600;">{{ vm.cpu_cores }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(139, 92, 246, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-memory me-2" style="font-size: 1.1rem; color: #8b5cf6; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">Memory</div>
                                        <div style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 1rem; font-weight: 600;">{{ vm.memory }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-hdd me-2" style="font-size: 1.1rem; color: #10b981; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">Node</div>
                                        <div style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 1rem; font-weight: 600;">{{ vm.vmi.node if vm.vmi else 'N/A' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="background: linear-gradient(135deg, rgba(234, 88, 12, 0.05) 0%, rgba(234, 88, 12, 0.02) 100%); padding: 0.875rem; border-radius: 8px; border: 1px solid rgba(234, 88, 12, 0.1);">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-activity me-2" style="font-size: 1.1rem; color: #ea580c; margin-top: 0.125rem;"></i>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6; margin-bottom: 0.375rem; font-weight: 600;">Status</div>
                                        <div>
                                            {% if vm.running %}
                                            <span style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.375rem 0.625rem; background: rgba(34, 197, 94, 0.15); color: rgb(21, 128, 61); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; display: inline-flex; align-items: center; gap: 0.375rem; font-weight: 600;"><span style="font-size: 0.5rem;">●</span><span>running</span></span>
                                            {% else %}
                                            <span style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.375rem 0.625rem; background: rgba(0, 0, 0, 0.06); color: rgba(0, 0, 0, 0.6); border: 1px solid rgba(0, 0, 0, 0.15); border-radius: 6px; display: inline-flex; align-items: center; gap: 0.375rem; font-weight: 600;"><span style="font-size: 0.5rem;">○</span><span>stopped</span></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid rgba(59, 130, 246, 0.1); margin: 0 -1.5rem; padding: 1.25rem 1.5rem 0; background: linear-gradient(180deg, rgba(59, 130, 246, 0.02) 0%, transparent 100%);">
                        <div style="font-size: 0.8125rem;">
                            <div class="mb-3">
                                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0.625rem; font-weight: 600;">
                                    <i class="bi bi-diagram-2 me-1" style="color: #3b82f6;"></i>Pod IPs
                                </div>
                                {% if vm.vmi and vm.vmi.ip_addresses %}
                                <div class="d-flex flex-wrap gap-1">
                                {% for ip in vm.vmi.ip_addresses %}
                                <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ ip }}</code>
                                {% endfor %}
                                </div>
                                {% else %}
                                <span style="opacity: 0.5; font-style: italic;">N/A</span>
                                {% endif %}
                            </div>
                            {% if vm.service %}
                            <div class="mb-3">
                                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0.625rem; font-weight: 600;">
                                    <i class="bi bi-hdd-network me-1" style="color: #8b5cf6;"></i>Service
                                </div>
                                <div style="padding-left: 0.5rem; border-left: 2px solid var(--border-color, #e5e7eb);">
                                    <div class="mb-2"><span style="opacity: 0.6; font-size: 0.75rem;">Type:</span> <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.type }}</code></div>
                                    {% if vm.service.annotations and (vm.service.annotations.get('external-dns.alpha.kubernetes.io/hostname') or vm.service.annotations.get('metallb.io/ip-allocated-from-pool')) %}
                                    <div>
                                        {% if vm.service.annotations.get('external-dns.alpha.kubernetes.io/hostname') %}
                                        <div class="mb-2">
                                            <span style="opacity: 0.6; font-size: 0.75rem;">FQDN:</span>
                                            <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.annotations['external-dns.alpha.kubernetes.io/hostname'] }}</code>
                                        </div>
                                        {% endif %}
                                        {% if vm.service.annotations.get('metallb.io/ip-allocated-from-pool') %}
                                        <div class="mb-2">
                                            <span style="opacity: 0.6; font-size: 0.75rem;">Pool:</span>
                                            <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.annotations['metallb.io/ip-allocated-from-pool'] }}</code>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% if vm.service.external_ips %}
                                    <div class="mb-2"><span style="opacity: 0.6; font-size: 0.75rem;">External IPs:</span>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                        {% for ip in vm.service.external_ips %}
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ ip }}</code>
                                        {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="mb-2"><span style="opacity: 0.6; font-size: 0.75rem;">Cluster IP:</span> <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.service.cluster_ip }}</code></div>
                                    <div><span style="opacity: 0.6; font-size: 0.75rem;">Ports:</span>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                        {% for port in vm.service.ports %}
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit; white-space: nowrap;">
                                            {{ port.name }}: {{ port.port }}:{{ port.target_port }}/{{ port.protocol }}
                                        </code>
                                        {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if vm.labels %}
                            <div>
                                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0.625rem; font-weight: 600;">
                                    <i class="bi bi-tags me-1" style="color: #10b981;"></i>Labels
                                </div>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for key, value in vm.labels.items() %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ key }}={{ value }}</code>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-footer border-top" style="padding: 1rem 1.5rem; background: linear-gradient(180deg, transparent 0%, rgba(59, 130, 246, 0.02) 100%); border-top: 1px solid rgba(59, 130, 246, 0.15);">
                    {% set has_ssh = vm.service and vm.service.type == 'LoadBalancer' and vm.service.ports and vm.user_data and 'ssh_pwauth: true' in vm.user_data %}
                    {% if has_ssh %}
                        {% set ns = namespace(found=false) %}
                        {% for port in vm.service.ports %}
                            {% if port.port == 22 %}
                                {% set ns.found = true %}
                            {% endif %}
                        {% endfor %}
                        {% set has_ssh = ns.found %}
                    {% else %}
                        {% set has_ssh = false %}
                    {% endif %}
                    
                    <div style="display: flex; {% if has_ssh %}justify-content: space-between;{% endif %} align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {% if vm.running %}
                            <button type="button" class="btn btn-sm btn-danger power-action" data-vm-name="{{ vm.name }}" data-action="stop" style="white-space: nowrap;">
                                <i class="bi bi-power me-1"></i>Stop
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-sm btn-success power-action" data-vm-name="{{ vm.name }}" data-action="start" style="white-space: nowrap;">
                                <i class="bi bi-power me-1"></i>Start
                            </button>
                            {% endif %}
                            {% if not has_ssh %}
                            <button type="button" class="btn btn-sm btn-outline-secondary view-yaml" data-vm-name="{{ vm.name }}" style="white-space: nowrap;">
                                <i class="bi bi-code-square me-1"></i>VM
                            </button>
                            {% if vm.service %}
                            <button type="button" class="btn btn-sm btn-outline-secondary view-service-yaml" data-service-name="{{ vm.name }}" style="white-space: nowrap;">
                                <i class="bi bi-code-square me-1"></i>Service
                            </button>
                            {% endif %}
                            {% endif %}
                        </div>
                        {% if has_ssh %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button type="button" class="btn btn-sm btn-outline-secondary view-yaml" data-vm-name="{{ vm.name }}" style="white-space: nowrap;">
                                <i class="bi bi-code-square me-1"></i>VM
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary view-service-yaml" data-service-name="{{ vm.name }}" style="white-space: nowrap;">
                                <i class="bi bi-code-square me-1"></i>Service
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ssh-button" 
                                    data-url="{{ url_for('main.terminal', vm_name=vm.name, host=vm.service.external_ips[0] if vm.service.external_ips else vm.service.cluster_ip) }}"
                                    data-vm-name="{{ vm.name }}" style="white-space: nowrap;">
                                <i class="bi bi-terminal me-1"></i>SSH
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="tableLayout" class="d-none">
        <div class="card border">
            <div class="card-body p-0">
                <table class="table table-hover mb-0" style="font-size: 0.875rem; width: 100%; table-layout: auto;">
                        <thead style="background-color: var(--surface-bg, #f9fafb); border-bottom: 1px solid var(--border-color, #e5e7eb);">
                            <tr>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Name</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Namespace</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Status</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">CPU</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Memory</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Node</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">IP Addresses</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Labels</th>
                                <th style="font-weight: 600; padding: 0.875rem 1rem;">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vm in vms %}
                            <tr style="border-bottom: 1px solid var(--border-color, #e5e7eb);">
                                <td style="padding: 0.875rem 1rem;">
                                    <i class="bi bi-pc me-2" style="opacity: 0.6;"></i>
                                    <span style="font-weight: 500;">{{ vm.name }}</span>
                                </td>
                                <td style="padding: 0.875rem 1rem;">{{ vm.namespace }}</td>
                                <td style="padding: 0.875rem 1rem;">
                                    <div style="display: flex; align-items: center;">
                                        {% if vm.running %}
                                        <span style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(34, 197, 94, 0.1); color: rgb(21, 128, 61); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 0.25rem; line-height: 1; display: flex; align-items: center; gap: 0.25rem;">●<span>running</span></span>
                                        {% else %}
                                        <span style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); color: rgba(0, 0, 0, 0.6); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; line-height: 1; display: flex; align-items: center; gap: 0.25rem;">○<span>stopped</span></span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td style="padding: 0.875rem 1rem;">
                                    <div style="display: flex; align-items: center;">
                                        <i class="bi bi-cpu" style="opacity: 0.5; margin-right: 0.5rem;"></i>
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; background: transparent; color: inherit;">{{ vm.cpu_cores }}</code>
                                    </div>
                                </td>
                                <td style="padding: 0.875rem 1rem;">
                                    <div style="display: flex; align-items: center;">
                                        <i class="bi bi-memory" style="opacity: 0.5; margin-right: 0.5rem;"></i>
                                        <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; background: transparent; color: inherit;">{{ vm.memory }}</code>
                                    </div>
                                </td>
                                <td style="padding: 0.875rem 1rem;">
                                    {% if vm.vmi %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit;">{{ vm.vmi.node }}</code>
                                    {% else %}
                                    <span style="opacity: 0.5; font-style: italic;">N/A</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.875rem 1rem; max-width: 250px;">
                                    {% if vm.vmi and vm.vmi.ip_addresses %}
                                    {% for ip in vm.vmi.ip_addresses %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit; display: inline-block; margin: 0.125rem; word-break: break-all;">{{ ip }}</code>
                                    {% endfor %}
                                    {% else %}
                                    <span style="opacity: 0.5; font-style: italic;">N/A</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.875rem 1rem; max-width: 300px;">
                                    {% for key, value in vm.labels.items() %}
                                    <code style="font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace; font-size: 0.8125rem; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0.25rem; color: inherit; display: inline-block; margin: 0.125rem; word-break: break-word;">{{ key }}={{ value }}</code>
                                    {% endfor %}
                                </td>
                                <td style="padding: 0.875rem 1rem;">{{ vm.created }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card border">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox mb-3" style="font-size: 4rem; opacity: 0.3; display: block;"></i>
            <h3 style="font-weight: 600; opacity: 0.7; margin-bottom: 0.5rem;">No VMs Found in Cluster</h3>
            <p style="opacity: 0.6; margin-bottom: 0;">No virtual machines were found running in the Kubernetes cluster</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- YAML Modal -->
<div class="modal" id="yamlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">VM YAML Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <pre style="margin: 0; border-radius: 0;"><code id="yamlContent" class="language-yaml" style="display: block; padding: 1.5rem; overflow-x: auto;"></code></pre>
            </div>
        </div>
    </div>
</div>

<!-- SSH Terminal Modal -->
<div class="modal" id="sshModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sshModalTitle">SSH Terminal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 0; height: 70vh;">
                <iframe id="sshIframe" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cardView = document.getElementById('cardView');
    const tableView = document.getElementById('tableView');
    const cardLayout = document.getElementById('cardLayout');
    const tableLayout = document.getElementById('tableLayout');

    // Load saved preference
    const viewPreference = localStorage.getItem('clusterVmViewPreference') || 'card';
    if (viewPreference === 'table') {
        showTableView();
    }

    cardView.addEventListener('click', function() {
        showCardView();
        localStorage.setItem('clusterVmViewPreference', 'card');
    });

    tableView.addEventListener('click', function() {
        showTableView();
        localStorage.setItem('clusterVmViewPreference', 'table');
    });

    function showCardView() {
        cardLayout.classList.remove('d-none');
        tableLayout.classList.add('d-none');
        cardView.classList.add('active');
        tableView.classList.remove('active');
    }

    function showTableView() {
        cardLayout.classList.add('d-none');
        tableLayout.classList.remove('d-none');
        cardView.classList.remove('active');
        tableView.classList.add('active');
    }

    // Load Highlight.js
    const hljs = window.hljs;

    // YAML Modal handling
    const yamlModal = new bootstrap.Modal(document.getElementById('yamlModal'));
    const yamlContent = document.getElementById('yamlContent');

    document.querySelectorAll('.view-yaml').forEach(button => {
        button.addEventListener('click', async function() {
            const vmName = this.dataset.vmName;
            try {
                const response = await fetch(`/api/vm/${vmName}/yaml`);
                const yaml = await response.text();
                yamlContent.textContent = yaml;
                if (hljs) {
                    delete yamlContent.dataset.highlighted;
                    hljs.highlightElement(yamlContent);
                }
                yamlModal.show();
            } catch (error) {
                console.error('Error fetching YAML:', error);
            }
        });
    });

    document.querySelectorAll('.view-service-yaml').forEach(button => {
        button.addEventListener('click', async function() {
            const serviceName = this.dataset.serviceName;
            try {
                const response = await fetch(`/api/service/${serviceName}/yaml`);
                const yaml = await response.text();
                yamlContent.textContent = yaml;
                if (hljs) {
                    delete yamlContent.dataset.highlighted;
                    hljs.highlightElement(yamlContent);
                }
                yamlModal.show();
            } catch (error) {
                console.error('Error fetching Service YAML:', error);
            }
        });
    });

    // SSH modal handling
    const sshModal = new bootstrap.Modal(document.getElementById('sshModal'));
    const sshIframe = document.getElementById('sshIframe');
    const sshModalTitle = document.getElementById('sshModalTitle');
    
    document.querySelectorAll('.ssh-button').forEach(button => {
        button.addEventListener('click', function() {
            const url = this.dataset.url + '&embedded=1';
            const vmName = this.dataset.vmName;
            sshModalTitle.textContent = `SSH Terminal - ${vmName}`;
            sshIframe.src = url;
            sshModal.show();
        });
    });
    
    // Clear iframe when modal is closed
    document.getElementById('sshModal').addEventListener('hidden.bs.modal', function() {
        sshIframe.src = '';
    });

    // Power management
    document.querySelectorAll('.power-action').forEach(button => {
        button.addEventListener('click', async function() {
            const vmName = this.dataset.vmName;
            const action = this.dataset.action;
            if (confirm(`Are you sure you want to ${action} VM ${vmName}?`)) {
                try {
                    const response = await fetch(`/api/vm/${vmName}/power/${action}`, {
                        method: 'POST'
                    });
                    if (response.ok) {
                        // Reload the page to show updated status
                        window.location.reload();
                    } else {
                        alert(`Failed to ${action} VM: ${await response.text()}`);
                    }
                } catch (error) {
                    console.error(`Error ${action}ing VM:`, error);
                    alert(`Error ${action}ing VM: ${error.message}`);
                }
            }
        });
    });
});
</script>
{% endblock %}
