{% if embedded %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH Terminal - {{ vm_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
        }
        #terminal-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #terminal {
            flex: 1;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="terminal-container">
        <div id="terminal"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script>
    // Sync theme from localStorage or parent window
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
    })();
    </script>
    <script>
    const term = new Terminal({
        cursorBlink: true,
        theme: {
            background: '#000000',
            foreground: '#ffffff'
        }
    });
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    // Create login form
    const loginForm = document.createElement('div');
    loginForm.innerHTML = `
        <div class="login-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div class="card" style="width: 350px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%); border-bottom: 1px solid rgba(147, 51, 234, 0.2); padding: 1rem;">
                    <h5 class="card-title mb-0" style="font-weight: 600; color: #3b82f6;">
                        <i class="bi bi-shield-lock me-2"></i>SSH Authentication
                    </h5>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <form id="sshLoginForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 500; font-size: 0.875rem;">
                                <i class="bi bi-person me-1"></i>Username
                            </label>
                            <input type="text" class="form-control" id="sshUsername" style="padding: 0.625rem;" placeholder="Enter username">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 500; font-size: 0.875rem;">
                                <i class="bi bi-key me-1"></i>Password
                            </label>
                            <input type="password" class="form-control" id="sshPassword" style="padding: 0.625rem;" placeholder="Enter password">
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="sshConnect" style="padding: 0.625rem; font-weight: 500; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border: none; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Connect
                        </button>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(loginForm);

    function connectSSH(event) {
        if (event) {
            event.preventDefault();
        }
        const username = document.getElementById('sshUsername').value;
        const password = document.getElementById('sshPassword').value;
        
        if (!username || !password) {
            alert('Please enter both username and password');
            return;
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/terminal/ws?host={{ host }}`);
        
        // Send credentials securely in first message
        ws.onopen = () => {
            // Send authentication message first
            ws.send(JSON.stringify({
                type: 'auth',
                username: username,
                password: password
            }));
        };

        // Handle successful authentication
        let authenticated = false;
        
        ws.onmessage = event => {
            term.write(event.data);
            
            if (!authenticated) {
                if (event.data.includes("Connected!")) {
                    authenticated = true;
                    loginForm.remove();
                    
                    // Set up terminal handlers after authentication
                    term.onData(data => {
                        ws.send(data);
                    });
                }
            }
        };

        ws.onclose = () => {
            term.write('\r\nConnection closed\r\n');
            // Show login form again on disconnect
            document.body.appendChild(loginForm);
        };

        ws.onerror = error => {
            console.error('WebSocket error:', error);
            term.write('\r\nWebSocket error occurred\r\n');
        };
    }

    // Add event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('sshLoginForm').addEventListener('submit', connectSSH);
        document.getElementById('sshConnect').addEventListener('click', connectSSH);
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        fitAddon.fit();
    });
    </script>
</body>
</html>
{% else %}
{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Terminal: {{ vm_name }}</h1>
    <div id="terminal" style="height: 600px; background: #000; padding: 10px; border-radius: 5px;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />

<script>
    const term = new Terminal({
        cursorBlink: true,
        theme: {
            background: '#000000',
            foreground: '#ffffff'
        }
    });
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    // Create login form
    const loginForm = document.createElement('div');
    loginForm.innerHTML = `
        <div class="login-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div class="card" style="width: 350px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%); border-bottom: 1px solid rgba(147, 51, 234, 0.2); padding: 1rem;">
                    <h5 class="card-title mb-0" style="font-weight: 600; color: #3b82f6;">
                        <i class="bi bi-shield-lock me-2"></i>SSH Authentication
                    </h5>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <form id="sshLoginForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 500; font-size: 0.875rem;">
                                <i class="bi bi-person me-1"></i>Username
                            </label>
                            <input type="text" class="form-control" id="sshUsername" style="padding: 0.625rem;" placeholder="Enter username">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 500; font-size: 0.875rem;">
                                <i class="bi bi-key me-1"></i>Password
                            </label>
                            <input type="password" class="form-control" id="sshPassword" style="padding: 0.625rem;" placeholder="Enter password">
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="sshConnect" style="padding: 0.625rem; font-weight: 500; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); border: none; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Connect
                        </button>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(loginForm);

    function connectSSH(event) {
        if (event) {
            event.preventDefault();
        }
        const username = document.getElementById('sshUsername').value;
        const password = document.getElementById('sshPassword').value;
        
        if (!username || !password) {
            alert('Please enter both username and password');
            return;
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/terminal/ws?host={{ host }}`);
        
        // Send credentials securely in first message
        ws.onopen = () => {
            // Send authentication message first
            ws.send(JSON.stringify({
                type: 'auth',
                username: username,
                password: password
            }));
        };

        // Handle successful authentication
        let authenticated = false;
        
        ws.onmessage = event => {
            term.write(event.data);
            
            if (!authenticated) {
                if (event.data.includes("Connected!")) {
                    authenticated = true;
                    loginForm.remove();
                    
                    // Set up terminal handlers after authentication
                    term.onData(data => {
                        ws.send(data);
                    });
                }
            }
        };

        ws.onclose = () => {
            term.write('\r\nConnection closed\r\n');
            // Show login form again on disconnect
            document.body.appendChild(loginForm);
        };

        ws.onerror = error => {
            console.error('WebSocket error:', error);
            term.write('\r\nWebSocket error occurred\r\n');
        };
    }

    // Add event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('sshLoginForm').addEventListener('submit', connectSSH);
        document.getElementById('sshConnect').addEventListener('click', connectSSH);
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        fitAddon.fit();
    });
</script>
{% endblock %}
{% endif %}
