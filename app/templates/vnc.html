{% if embedded %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VNC - {{ vm_name }}</title>
  <style>
    html, body { height: 100%; }
    /* Prevent outer page scrollbar to avoid double-scroll */
    body { margin:0; padding:0; background:#000; display:flex; flex-direction:column; overflow:hidden; }
    .toolbar { display:flex; gap:.5rem; align-items:center; padding:.5rem; background:#111; color:#ddd; border-bottom: 1px solid #222; }
    .toolbar .spacer { flex:1; }
    .toolbar button { padding:.35rem .6rem; font-size:.9rem; border:1px solid #333; background:#1a1a1a; color:#eee; border-radius:4px; cursor:pointer; }
    .toolbar button:hover { background:#222; }
    /* The VNC container can provide its own scroll in 1:1 mode */
    #vnc { width: 100%; height: calc(100vh - 44px); background: #000; overflow:hidden; }
    .status { font-size:.85rem; opacity:.8; }
  </style>
</head>
<body>
  <div class="toolbar">
    <strong>{{ vm_name }}</strong>
    <span class="status" id="status">Connecting…</span>
    <div class="spacer"></div>
    <button id="fit">Fit to window</button>
    <button id="native">1:1</button>
    <button id="clip">Toggle clip</button>
    <button id="cad">Ctrl+Alt+Del</button>
    <button id="fs">Fullscreen</button>
  </div>
  <div id="vnc"></div>
  <script type="module">
  import RFB from 'https://esm.sh/@novnc/novnc@1.5.0/lib/rfb.js';
  const url = `${(location.protocol === 'https:' ? 'wss:' : 'ws:')}//${location.host}/vnc/ws?vm_name={{ vm_name }}&namespace={{ namespace }}`;
  const rfb = new RFB(document.getElementById('vnc'), url);
  rfb.viewOnly = false;
  rfb.scaleViewport = true;
  rfb.clipViewport = false;
  rfb.resizeSession = true;
  rfb.background = '#000';

  const statusEl = document.getElementById('status');
  rfb.addEventListener('connect', () => { statusEl.textContent = 'Connected'; });
  rfb.addEventListener('disconnect', e => { statusEl.textContent = 'Disconnected'; console.error('VNC disconnected', e); });

  const vncEl = document.getElementById('vnc');

  document.getElementById('fit').addEventListener('click', () => {
    rfb.scaleViewport = true;
    rfb.clipViewport = false;
    // In fit mode, allow server-side resize to match window
    rfb.resizeSession = true;
    // Avoid inner scrollbars in fit mode
    vncEl.style.overflow = 'hidden';
  });
  document.getElementById('native').addEventListener('click', () => {
    rfb.scaleViewport = false;
    rfb.clipViewport = false;
    // In 1:1 mode, keep the remote resolution fixed
    rfb.resizeSession = false;
    // Provide a single scrollbar at the container level to avoid double-scroll
    vncEl.style.overflow = 'auto';
  });
  document.getElementById('clip').addEventListener('click', () => {
    rfb.clipViewport = !rfb.clipViewport;
  });
  document.getElementById('cad').addEventListener('click', () => {
    try { rfb.sendCtrlAltDel(); } catch (e) { console.warn(e); }
  });
  document.getElementById('fs').addEventListener('click', () => {
    const el = document.documentElement;
    if (!document.fullscreenElement) {
      el.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });
  </script>
</body>
</html>
{% else %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Open VNC</title>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    .wrap { padding: 16px; }
    .hint { color: #666; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Opening VNC…</h1>
    <p class="hint">If the popup is blocked, click the button below.</p>
    <button id="openVncLink">Open Console</button>
  </div>
<script>
// Use the default noVNC UI app page and point it to our WS proxy via path
// Open our embedded viewer (with full controls) in a normal popup window
const openUrl = `${location.origin}/vnc/{{ vm_name }}?namespace={{ namespace }}&embedded=1`;
// Attempt auto popout in a WINDOW (not a tab) with resizable features
const features = [
  'popup=yes',
  'toolbar=no',
  'location=no',
  'menubar=no',
  'status=no',
  'scrollbars=yes',
  'resizable=yes',
  `width=${Math.min(screen.availWidth, 1280)}`,
  `height=${Math.min(screen.availHeight, 800)}`
].join(',');
const win = window.open(openUrl, 'kubevirt-vnc', features);
if (win) {
  try {
    win.focus();
    // Close the current page to leave only the popout
    window.close();
  } catch (e) {}
}
// Ensure user-gesture fallback always works via button
const link = document.getElementById('openVncLink');
link.addEventListener('click', (e) => {
  e.preventDefault();
  const w = window.open(openUrl, 'kubevirt-vnc', features);
  if (w) {
    try { w.focus(); } catch {}
    setTimeout(() => { try { window.close(); } catch {} }, 100);
  } else {
    // As a fallback, navigate current tab
    location.href = openUrl;
  }
});
</script>
</body>
</html>
{% endif %}
